<html>
	<title>iDoc</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<style>
html {
	font-family: sans-serif;
}
div#filesystem, div#preview {
	position: absolute;
	background-color: #f3f7fc;
	color: #aaa;
	border: #d2dbed 1px solid;
	border-radius: 3px;
	padding: 10px;
}
div#filesystem {
	width: 33%;
	height: 85%;
	left: 2%;
	overflow: auto;
}
div#filesystem table {
	width: 100%;
	color: #444;
}
div#filesystem table td.small {
	width: 10px;
}
div#preview {
	width: 55%;
	right: 2%;
	height: 85%;
}
div#preview iframe {
	width: 99%;
	height: 89%;
	border: dashed 1px #d2dbed;
}
h1 {
	font-family: monospace;
	font-weight: bold;
	margin-left: 10%;
	margin-bottom: 10px;
	font-size: xx-large;
}
h2 {
	font-size: 1.1em;
	font-weight: bold;
	font-style: italic;
	font-family: cursive;
	margin-left: 30px;
}
div.hr {
	height: 7px;
	border-bottom: solid 1px #d2dbed;
}
a.name, a.name:visited {
	-webkit-transition: text-shadow 0.5s ease-out;
	color: #444;
	text-decoration: none;
}
a.name:hover {
	text-shadow: 0px 0px 4px #409;
}
a.folder, a.folder:visited {
	-webkit-transition: text-shadow 0.5s ease-out;
	color: #777;
	text-decoration: none;
}
a.folder:hover {
	text-shadow: 0px 0px 4px #904;
}
	</style>
	<body onload="init()">
	<script>
function newFile() {
	var fileName = prompt("Name of the file:"); // ask name.
	if(fileName!='')
		localStorage['iDoc-'+fileName] = ''; // store file info.
	// is it a file or a folder?
	if(fileName.indexOf('/') == -1)
		showFile(fileName, document.getElementById('fsHr').sectionRowIndex+1);
	else {
		var folder = fileName.slice(0,fileName.indexOf('/')+1);
		// we need to see whether the folder already exists.
		var exists = false;
		var rows = document.getElementById('fs').rows;
		for(var i=0; i<rows.length; i++) {
			if(rows[i].getAttribute('id') == 'fold'+folder) {
				exists = true;
				// is the folder open visually?
				if(rows[i].firstChild.textContent[0] != '>') {
					showFile(fileName, i+1);
				}
				break;
			}
		}
		// new folder!
		if( !exists )  showFolder(folder, 0);
	}
}
function showFile(f, place) {
	var fsTable = document.getElementById("fs");
	var fRow = fsTable.insertRow(place);
	// update ui.
	fRow.id = 'file'+f;
	fRow.innerHTML = fileInRow(f);
}
function showFolder(f, place) {
	var fsTable = document.getElementById("fs");
	var fRow = fsTable.insertRow(place);
	// update ui.
	fRow.id = 'fold'+f;
	fRow.innerHTML = folderInRow(f);
}
function rmFile(file) {
	var ls = localStorage;
	ls.removeItem('iDoc-'+file);
	var id = document.getElementById("file"+file).sectionRowIndex;
	hideFile(id);
	// What if it is the last file of the folder?
	var folder = file.slice(0,file.indexOf('/')+1);
	var stillSome = false;
	for(var i=0; i<ls.length; i++) { // parse through storage data.
		var f = ls.key(i);
		if(f.substring(0,5) == 'iDoc-') f = f.substring(5);
		else continue;
		// We want those that have the same folder as the removed file.
		var folderName = f.slice(0,f.indexOf('/')+1);
		if(folderName == folder)
			stillSome = true;
	}
	if( !stillSome )  // if there is no more file in the folder...
		hideFile(id-1);  // ... remove the folder in the ui.
}
function hideFile(place) {
	document.getElementById("fs").deleteRow(place);
}
function preview(file) {
	var prev = document.getElementById('ifpreview').contentDocument;
	prev.open();
	prev.write('<!DOCTYPE html>\n<html>'+localStorage['iDoc-'+file]+'</html>');
	prev.close();
}
function openFolder(name, caller) {
	var ls = localStorage;
	var iTbl = document.getElementById('fold'+name).sectionRowIndex;
	for(var i=0; i<ls.length; i++) { // parse through storage data.
		var f = ls.key(i);
		if(f.substring(0,5) == 'iDoc-') f = f.substring(5);
		else continue;
		// We want those that are named name.
		var folderName = f.slice(0,f.indexOf('/')+1);
		if(folderName == name) {
			// name.
			var nextName = f.slice(f.indexOf('/'));
			nextName = nextName.slice(0,nextName.indexOf('/')+1);
			// index in table.
			iTbl++;
			// show it.
			showFile(f, iTbl);
		}
	}
	caller.parentNode.previousSibling.textContent = 'v';
	caller.setAttribute('onclick', "closeFolder('"+name+"', this)");
}
function closeFolder(name, caller) {
	var table = document.getElementById('fs');
	var row = caller.parentNode.parentNode.nextSibling;
	var rowId = row.sectionRowIndex;
	var rowName = row.firstChild.nextSibling.nextSibling.textContent;
	while(rowName.slice(0,rowName.indexOf('/')+1) == name) {
		hideFile(rowId);  // deletes the row (next row = same id).
		row = table.rows[rowId];
		if(row && row.firstChild.nextSibling
		   && row.firstChild.nextSibling.nextSibling)
			rowName = row.firstChild.nextSibling.nextSibling.textContent;
		else break;
	}
	caller.parentNode.previousSibling.textContent = '>';
	caller.setAttribute('onclick', "openFolder('"+name+"', this)");
}

function fileRow(fileName) {
	return '<tr id="file'+fileName+'">'+fileInRow(fileName);
}
function fileInRow(fileName) {
	return '<td><td class="small"><a href="javascript:void(0)" '+
			'class="folder" onclick="rmFile(\''+fileName+'\')">x</a>'+
			'<td><a href="javascript:void(0)" class="name" '+
			'onmouseover="preview(\''+fileName+'\')">'+fileName+'</a>';
}
function folderRow(folderName) {
	return '<tr id="fold'+folderName+'">'+folderInRow(folderName);
}
function folderInRow(folderName) {
	return '<td class="small">&gt;'+
			'<td colspan=2><a href="javascript:void(0)" class="folder" '+
			'onclick="openFolder(\''+folderName+'\', this)">'+
			folderName+'</a>';
}


function init() {
	var folders = [];
	var inTable = '';
	//var inTable = '<tr><td colspan=3>\n<a class="folder" '+
	//			'href="javascript:void(0)" onclick="newFile()">New File</a>';
	var uiFs = document.getElementById('fs');
	// Show a table of current files.
	if(localStorage.length > 0) {
		var ls = localStorage;
		// First show folders.
		for(var i=0; i<ls.length; i++) {
			var f = ls.key(i);
			if(f.substring(0,5) == 'iDoc-') f = f.substring(5);
			else continue;
			if(f.indexOf('/')!=-1) {
				// We have a folder here.
				// find name of folder.
				var folderName = '';
				if(f.indexOf('/')) folderName = f.substring(0,f.indexOf('/')+1);
				else folderName = f.substring(0,f.indexOf('\\')+1);
				// is this folder already listed?
				var folderAlreadyListed = false; // ...java-lengthed variable ;)
				for(var j=0; j<folders.length; j++)
					if(folders[j] == folderName)
						folderAlreadyListed = true;
				if(!folderAlreadyListed) { // show the folder.
					folders.push(folderName);
					inTable += folderRow(folderName);
				}
			}
		}
		// Then show files in the master directory.
		inTable += '<tr id="fsHr"><td colspan=3><div class=hr></div>';
		for(var i=0; i<ls.length; i++) {
			var f = ls.key(i);
			if(f.substring(0,5) == 'iDoc-') f = f.substring(5);
			else continue;
			if(f.indexOf('/')==-1) // We have a file here.
				inTable += fileRow(f);
		}
	}
	uiFs.innerHTML = inTable;
}
	</script>
	<h1>iDoc</h1>
	<div id="filesystem">
		<h2>Drafts File System</h2>
		<button onclick="newFile()">New File</button>
		<table id="fs"></table>
	</div>
	<div id="preview">
		<h2>Preview</h2>
		<iframe id="ifpreview"></iframe>
	</div>
	</body>
</html>
